name: SAST

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  brakeman:
    name: Brakeman
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.2"
          bundler-cache: false

      - name: Install Brakeman
        run: gem install brakeman

      - name: Run Brakeman
        run: |
          brakeman --format json --output results.json --confidence-level 2 --except CheckRender -i config/brakeman.ignore . || true

          HIGH=$(jq '.warnings | map(select(.confidence == "High")) | length' results.json)
          MEDIUM=$(jq '.warnings | map(select(.confidence == "Medium")) | length' results.json)
          LOW=$(jq '.warnings | map(select(.confidence == "Low")) | length' results.json)

          echo "## Brakeman" >> $GITHUB_STEP_SUMMARY
          echo "- High: $HIGH | Medium: $MEDIUM | Low: $LOW" >> $GITHUB_STEP_SUMMARY

          if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
            echo "❌ Build BLOCKED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload SARIF
        if: always()
        run: brakeman --format sarif --output results.sarif --confidence-level 2 -i config/brakeman.ignore . || true

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: brakeman
        continue-on-error: true

  semgrep:
    name: Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config p/security-audit \
            --config p/rails \
            --config p/owasp-top-ten \
            --config p/javascript \
            --sarif --output results.sarif \
            --metrics=off . || true

          ERROR=$(jq '.runs[0].results | map(select(.level == "error")) | length' results.sarif)
          WARNING=$(jq '.runs[0].results | map(select(.level == "warning")) | length' results.sarif)

          echo "## Semgrep" >> $GITHUB_STEP_SUMMARY
          echo "- Error: $ERROR | Warning: $WARNING" >> $GITHUB_STEP_SUMMARY

          if [ "$ERROR" -gt 0 ] || [ "$WARNING" -gt 10 ]; then
            echo "❌ Build BLOCKED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: semgrep
        continue-on-error: true

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [brakeman, semgrep]
    if: always()

    steps:
      - run: |
          echo "## SAST Results" >> $GITHUB_STEP_SUMMARY
          echo "Brakeman: ${{ needs.brakeman.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Semgrep: ${{ needs.semgrep.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.brakeman.result }}" == "failure" ] || [ "${{ needs.semgrep.result }}" == "failure" ]; then
            echo "❌ Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
