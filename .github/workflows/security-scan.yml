name: Security Scan

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version

      - name: Bundler audit
        id: bundler-audit
        run: |
          gem install bundler-audit
          bundle audit update

          # Run audit and capture output
          bundle audit check --format json > bundler-audit.json || true

          # Check for high/critical vulnerabilities
          HIGH_CRIT=$(jq '[.results[].advisory.criticality | select(. == "high" or . == "critical")] | length' bundler-audit.json)
          TOTAL=$(jq '.results | length' bundler-audit.json)

          echo "## Bundler Audit" >> $GITHUB_STEP_SUMMARY
          echo "Total vulnerabilities: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "High/Critical: $HIGH_CRIT" >> $GITHUB_STEP_SUMMARY

          if [ "$HIGH_CRIT" -gt 0 ]; then
            echo "::error::$HIGH_CRIT high/critical vulnerabilities found in Ruby dependencies"
            jq -r '.results[] | select(.advisory.criticality == "high" or .advisory.criticality == "critical") | "- \(.advisory.id): \(.gem.name) - \(.advisory.title)"' bundler-audit.json >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Yarn audit
        id: yarn-audit
        run: |
          yarn install --frozen-lockfile --ignore-scripts

          # Allowlisted advisories (no patch available)
          # 1108111: xlsx ReDoS - using official SheetJS CDN, only processes trusted uploads
          ALLOWLIST="1108111"

          yarn audit --level high --groups dependencies --json > audit.json || true

          # Filter out allowlisted advisories and check remaining
          UNALLOWED=$(jq -r --arg allowlist "$ALLOWLIST" '
            select(.type == "auditAdvisory")
            | .data.advisory.id
            | tostring
            | select(. as $id | ($allowlist | split(" ") | index($id) | not))
          ' audit.json)

          if [ -n "$UNALLOWED" ]; then
            echo "::error::High severity vulnerabilities found"
            yarn audit --level high --groups dependencies
            exit 1
          fi

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version

      - name: Generate reports
        run: |
          mkdir -p tmp/security-reports
          DATE=$(date +%Y%m%d-%H%M%S)

          gem install bundler-audit
          bundle audit update
          bundle audit check --format json > "tmp/security-reports/bundler-${DATE}.json" || true

          yarn install --frozen-lockfile --ignore-scripts
          yarn audit --json > "tmp/security-reports/yarn-${DATE}.json" || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_id }}
          path: tmp/security-reports/
          retention-days: 90
