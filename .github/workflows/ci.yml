name: CI
on: push
jobs:
  linters:
    name: Linters
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Cache js dependencies
        uses: actions/cache@v4
        with:
          key: node_modules-${{ hashFiles('yarn.lock') }}
          path: node_modules
      - name: Install JS dependencies
        run: yarn install
      - name: Run Rubocop
        run: bundle exec rubocop
      - name: Run ESLint
        run: yarn lint

  test_unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ci_node_total: [4]
        ci_node_index: [0, 1, 2, 3]
    services:
      postgres:
        image: postgres:13.2
        env:
          POSTGRES_USER: rdv_insertion_test
          POSTGRES_PASSWORD: rdv_insertion_test
          POSTGRES_DB: rdv_insertion_test
        options: >-
          --mount type=tmpfs,destination=/var/lib/postgresql/data
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis
        ports:
          - 6379:6379
        options: --entrypoint redis-server
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Cache js dependencies
        uses: actions/cache@v4
        with:
          key: node_modules-${{ hashFiles('yarn.lock') }}
          path: node_modules
      - name: Install JS dependencies
        run: yarn install
      - name: Precompile assets
        run: yarn run build
      - name: Prepare runtime log cache key
        run: |
          mkdir -p tmp
          ls spec/**/*.rb > tmp/spec_files.txt
      - name: Cache parallel test unit spec runtime log
        uses: actions/cache@v4
        with:
          key: unit-spec-runtime-log-${{ hashFiles('tmp/spec_files.txt') }}
          path: tmp/parallel_runtime_rspec.log
      - name: Setup test database and run specs
        run: |
          RAILS_ENV=test bundle exec rake parallel:drop parallel:create parallel:load_schema
          bundle exec parallel_test spec/ --type rspec --exclude-pattern "spec/features/"
        env:
          HOST: http://example.com
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: rdv_insertion_test
          POSTGRES_PASSWORD: rdv_insertion_test
          POSTGRES_DB: rdv_insertion_test
          CI_NODE_TOTAL: ${{ matrix.ci_node_total }}
          CI_NODE_INDEX: ${{ matrix.ci_node_index }}

  test_features:
    name: Feature Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ci_node_total: [4]
        ci_node_index: [0, 1, 2, 3]
    services:
      postgres:
        image: postgres:13.2
        env:
          POSTGRES_USER: rdv_insertion_test
          POSTGRES_PASSWORD: rdv_insertion_test
          POSTGRES_DB: rdv_insertion_test
        options: >-
          --mount type=tmpfs,destination=/var/lib/postgresql/data
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis
        ports:
          - 6379:6379
        options: --entrypoint redis-server
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      - name: Cache js dependencies
        uses: actions/cache@v4
        with:
          key: node_modules-${{ hashFiles('yarn.lock') }}
          path: node_modules
      - name: Install JS dependencies
        run: yarn install
      - name: Precompile assets
        run: RAILS_ENV=test bundle exec rake assets:precompile
      - name: Prepare runtime log cache key
        run: |
          mkdir -p tmp
          ls spec/features/**/*.rb > tmp/feature_spec_files.txt
      - name: Cache parallel test feature spec runtime log
        uses: actions/cache@v4
        with:
          key: feature-spec-runtime-log-${{ hashFiles('tmp/feature_spec_files.txt') }}
          path: tmp/parallel_runtime_rspec.log
      - name: Setup test database and run specs
        run: |
          RAILS_ENV=test bundle exec rake parallel:drop parallel:create parallel:load_schema
          bundle exec parallel_test spec/features --type rspec
        env:
          HOST: http://example.com
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: rdv_insertion_test
          POSTGRES_PASSWORD: rdv_insertion_test
          POSTGRES_DB: rdv_insertion_test
          CI_NODE_TOTAL: ${{ matrix.ci_node_total }}
          CI_NODE_INDEX: ${{ matrix.ci_node_index }}
